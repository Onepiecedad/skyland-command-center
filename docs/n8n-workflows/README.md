# n8n Workflow: Skyland Task Approved

> **Workflow ID:** `dMbftL2LXAdklUD9`  
> **Production URL:** `https://n8n.skylandai.se/webhook/skyland/task-approved`

---

## Workflow Overview

```
Webhook → Is Research Task? 
              ├─ TRUE  → Extract Query → Firecrawl Search → Build Report → Send to Skyland
              └─ FALSE → Build Noop Result → Send to Skyland
```

---

## Incoming Payload (from Backend)

The backend `POST /dispatch` sends:

```json
{
  "task_id": "<uuid>",
  "run_id": "<uuid>",
  "title": "Research XYZ",
  "executor": "n8n:research",
  "callback_url": "https://<ngrok-or-prod>/api/v1/n8n/task-result"
}
```

---

## Callback Payload Mapping

The n8n workflow **MUST** send these fields back to `callback_url`:

| Field | Source | Required |
|-------|--------|----------|
| `task_id` | `body.task_id` from webhook | ✅ Yes |
| `run_id` | `body.run_id` from webhook | ✅ Yes |
| `success` | Hardcoded `true` (or `false` on error) | ✅ Yes |
| `output` | Generated by Build Report node | No |
| `error` | Error message if failed | No |

---

## Node Details

### Extract Query (Code Node)

Extracts fields from webhook body and passes them through the pipeline:

```javascript
const body = $input.first().json.body;
const title = body.title || '';
const query = title.replace(/^research\s+/i, '').trim();

return [{
  json: {
    query,
    task_id: body.task_id,    // ← CRITICAL: pass through
    run_id: body.run_id,      // ← CRITICAL: pass through
    callback_url: body.callback_url
  }
}];
```

### Build Report (Code Node)

Builds the callback payload with **all required fields**:

```javascript
const extractData = $('Extract Query').first().json;
const task_id = extractData.task_id;
const run_id = extractData.run_id;
const callback_url = extractData.callback_url;

// ... build report from Firecrawl results ...

return [{
  json: {
    task_id: task_id,         // ← Required
    run_id: run_id,           // ← Required  
    success: true,            // ← Required (boolean!)
    severity: 'info',
    summary: 'Research completed',
    output: { report_markdown, sources, ... },
    callback_url
  }
}];
```

### Build Noop Result (Code Node)

For non-research tasks:

```javascript
const body = $input.first().json.body;

return [{
  json: {
    task_id: body.task_id,    // ← Required
    run_id: body.run_id,      // ← Required
    success: true,            // ← Required
    severity: 'info',
    summary: 'Not a research task',
    output: { noop: true },
    callback_url: body.callback_url
  }
}];
```

### Send to Skyland (HTTP Request Node)

Sends to `callback_url` with JSON body:

```json
{
  "task_id": "{{ $json.task_id }}",
  "run_id": "{{ $json.run_id }}",
  "success": {{ $json.success }},
  "severity": "{{ $json.severity }}",
  "summary": "{{ $json.summary }}",
  "output": {{ JSON.stringify($json.output) }}
}
```

---

## Common Errors

### `run_id: expected string, received undefined`

**Cause:** Build Report/Noop node not passing `run_id` from Extract Query.  
**Fix:** Ensure `run_id: extractData.run_id` is set.

### `success: expected boolean, received undefined`  

**Cause:** Missing `success: true` in return object.  
**Fix:** Add `success: true` (or `false`) to the return payload.

---

## Updating the Workflow

When modifying the n8n workflow:

1. **Always preserve** `task_id`, `run_id`, `callback_url` through all nodes
2. **Always set** `success` as a boolean (not string)
3. Test with the regression curl commands in [N8N_CONTRACT.md](../N8N_CONTRACT.md)
